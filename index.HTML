<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Chidiya ‚Äî Flap Game üê¶</title>
  <style>
    :root {
      --bg-top: #85d6ff;
      --bg-bot: #c9efff;
      --pipe-body1: #1dbf43;
      --pipe-body2: #0aa83a;
      --pipe-stroke: #0a7a2e;
      --ui-bg: rgba(0,0,0,0.28);
      --text: #ffffff;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; background: #5cc3ff; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      user-select: none;
    }

    /* Game root */
    #game {
      position: relative;
      width: 100vw;
      height: 100vh;
      height: 100svh;
      height: 100dvh;
      overflow: hidden;
      background: linear-gradient(180deg, var(--bg-top) 0%, var(--bg-bot) 70%);
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }

    /* Layers z-order:
       pipes 20, ground 25, bird 30, tapLayer 10, overlays 60, topbar 50 */
    #tapLayer { position: absolute; inset: 0; z-index: 10; }

    #pipes {
      position: absolute;
      top: 0; left: 0; right: 0;
      height: calc(100% - var(--ground-h, 90px)); /* align with playable area */
      z-index: 20;
      pointer-events: none;
    }
    .pipe { position: absolute; top: 0; left: 0; height: 100%; width: var(--pipe-w, 90px); }
    .pipe .part {
      position: absolute; left: 0; width: 100%;
      background: linear-gradient(180deg, var(--pipe-body1), var(--pipe-body2));
      border: 2px solid var(--pipe-stroke);
      border-radius: 6px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.18);
    }
    .pipe .part.top { top: 0; border-bottom-left-radius: 0; border-bottom-right-radius: 0; }
    .pipe .part.bottom { bottom: 0; border-top-left-radius: 0; border-top-right-radius: 0; }

    .bird {
      position: absolute;
      width: var(--bird-size, 28px);
      height: var(--bird-size, 28px);
      border-radius: 50%;
      background: radial-gradient(circle at 35% 35%, #fff7a1 0%, #ffcf48 55%, #f7a21a 100%);
      box-shadow: 0 3px 0 rgba(0,0,0,0.22) inset, 0 10px 20px rgba(0,0,0,0.25);
      will-change: transform;
      pointer-events: none;
      z-index: 30;
    }
    .bird::after {
      content: ""; position: absolute; right: -18%; top: 50%;
      transform: translateY(-50%); width: 30%; height: 28%;
      background: #ff8a00; border-radius: 0 50% 50% 0; box-shadow: 0 0 0 2px rgba(0,0,0,0.08) inset;
    }
    .bird::before {
      content: ""; position: absolute; left: 56%; top: 28%;
      width: 12%; height: 12%; background: #000; border-radius: 50%;
      box-shadow: 2px 0 0 3px #fff;
    }

    .ground {
      position: absolute; left: 0; right: 0; bottom: 0;
      height: var(--ground-h, 90px);
      background: repeating-linear-gradient(-45deg, #6fcf3c 0 14px, #7be243 14px 28px);
      border-top: 4px solid #438c1d;
      box-shadow: 0 -6px 16px rgba(0,0,0,0.25);
      z-index: 25;
      background-position-x: 0;
      pointer-events: none;
    }
    @keyframes groundMove { from { background-position-x: 0; } to { background-position-x: -100px; } }
    .ground.scrolling { animation: groundMove var(--ground-period, 0.8s) linear infinite; }

    /* Topbar */
    .topbar {
      position: absolute; top: calc(env(safe-area-inset-top, 0px) + 8px);
      left: 0; right: 0; display: flex; align-items: center; justify-content: center;
      z-index: 50; pointer-events: none;
    }
    .score {
      font-weight: 800; letter-spacing: 1px; text-shadow: 0 2px 0 rgba(0,0,0,0.35);
      font-size: clamp(22px, 6vw, 48px); pointer-events: none;
    }
    .icon-btn {
      position: absolute; right: calc(env(safe-area-inset-right, 0px) + 10px);
      padding: 10px 12px; border-radius: 10px; border: 0;
      color: #003b5b; background: #fff; font-weight: 800; cursor: pointer;
      box-shadow: 0 6px 14px rgba(0,0,0,0.25); pointer-events: auto; font-size: 16px;
    }
    .icon-btn:active { transform: translateY(1px); }

    /* Overlays */
    .overlay {
      position: absolute; left: 50%; top: 46%; transform: translate(-50%, -50%);
      text-align: center; background: var(--ui-bg); padding: 16px 20px; border-radius: 14px;
      backdrop-filter: blur(4px); z-index: 60; max-width: min(92vw, 560px); color: #fff;
      box-shadow: 0 12px 24px rgba(0,0,0,0.2);
    }
    .overlay h1, .overlay h2 { margin: 6px 0 10px; }
    .overlay p { margin: 8px 0; opacity: 0.98; }
    .btn {
      margin-top: 10px; padding: 10px 16px; border-radius: 10px; border: 0;
      color: #003b5b; background: #fff; font-weight: 700; cursor: pointer;
      box-shadow: 0 6px 14px rgba(0,0,0,0.25);
    }
    .btn:active { transform: translateY(1px); }

    /* Settings */
    .settings .row { display: flex; align-items: center; justify-content: space-between; gap: 12px; margin: 8px 0; }
    .settings .row label { text-align: left; flex: 1; }
    .settings .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 8px; }

    .hidden { display: none; }

    .credit {
      position: absolute; bottom: calc(env(safe-area-inset-bottom, 0px) + 6px); right: 8px;
      font-size: 12px; opacity: 0.9; z-index: 45; color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.35);
      pointer-events: none;
    }
  </style>
</head>
<body>
  <div id="game" role="application" aria-label="Chidiya Game">
    <!-- Tap capture layer (for flaps only) -->
    <div id="tapLayer" aria-hidden="true"></div>

    <!-- World -->
    <div id="pipes" aria-hidden="true"></div>
    <div id="bird" class="bird" aria-hidden="true"></div>
    <div id="ground" class="ground" aria-hidden="true"></div>

    <!-- Top bar -->
    <div class="topbar">
      <div id="score" class="score" aria-live="polite">0</div>
      <button id="settingsBtn" class="icon-btn" type="button" aria-haspopup="dialog" aria-controls="settingsPanel" title="Settings (S)">‚öôÔ∏è</button>
    </div>

    <!-- Start -->
    <div id="msg" class="overlay" role="dialog" aria-label="Start">
      <h1>Ready to fly? üê¶</h1>
      <p>Tap to flap. Desktop: Space/Click. Enter to start.</p>
      <button id="playBtn" class="btn" type="button">Play</button>
      <p class="small">Made by <strong>Kishan Pandey</strong></p>
    </div>

    <!-- Game over -->
    <div id="gameover" class="overlay hidden" role="dialog" aria-label="Game over">
      <h2>Nice try!</h2>
      <p>Score: <span id="finalScore">0</span> ‚Ä¢ Best: <span id="bestScore">0</span></p>
      <button id="restartBtn" class="btn" type="button">Restart</button>
      <p class="small">Made by <strong>Kishan Pandey</strong></p>
    </div>

    <!-- Settings -->
    <div id="settingsPanel" class="overlay settings hidden" role="dialog" aria-label="Game settings">
      <h2>Settings</h2>
      <div class="row">
        <label for="sfxToggle">Sound effects</label>
        <input id="sfxToggle" type="checkbox" />
      </div>
      <div class="row">
        <label for="musicToggle">Music</label>
        <input id="musicToggle" type="checkbox" />
      </div>
      <div class="row">
        <label for="hapticsToggle">Haptics (vibration)</label>
        <input id="hapticsToggle" type="checkbox" />
      </div>
      <div class="row">
        <label for="difficultySel">Difficulty</label>
        <select id="difficultySel">
          <option value="easy">Easy</option>
          <option value="normal">Normal</option>
          <option value="hard">Hard</option>
        </select>
      </div>
      <div class="row">
        <label for="themeSel">Theme</label>
        <select id="themeSel">
          <option value="day">Day</option>
          <option value="night">Night</option>
        </select>
      </div>
      <div class="grid">
        <button id="closeSettings" class="btn" type="button">Close</button>
        <button id="resetBest" class="btn" type="button">Reset Best</button>
      </div>
      <p class="small"></p>
    </div>

    <div class="credit">Made by <strong>Kishan Pandey</strong></div>
  </div>

  <script>
    (() => {
      'use strict';

      // DOM refs
      const game = document.getElementById('game');
      const tapLayer = document.getElementById('tapLayer');
      const pipesLayer = document.getElementById('pipes');
      const birdEl = document.getElementById('bird');
      const groundEl = document.getElementById('ground');
      const scoreEl = document.getElementById('score');
      const msg = document.getElementById('msg');
      const gameover = document.getElementById('gameover');
      const playBtn = document.getElementById('playBtn');
      const restartBtn = document.getElementById('restartBtn');
      const finalScoreEl = document.getElementById('finalScore');
      const bestScoreEl = document.getElementById('bestScore');

      const settingsBtn = document.getElementById('settingsBtn');
      const settingsPanel = document.getElementById('settingsPanel');
      const sfxToggle = document.getElementById('sfxToggle');
      const musicToggle = document.getElementById('musicToggle');
      const hapticsToggle = document.getElementById('hapticsToggle');
      const difficultySel = document.getElementById('difficultySel');
      const themeSel = document.getElementById('themeSel');
      const closeSettings = document.getElementById('closeSettings');
      const resetBestBtn = document.getElementById('resetBest');

      // Utils
      const clamp = (v, min, max) => Math.max(min, Math.min(max, v));
      const rand = (a, b) => a + Math.random() * (b - a);
      const cssVar = (name, val) => game.style.setProperty(name, typeof val === 'number' ? val + 'px' : val);

      // Persist
      const persisted = {
        get(k, d){ try{ const v = localStorage.getItem(k); return v==null? d : JSON.parse(v);}catch{return d;} },
        set(k, v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch{} }
      };

      const settings = persisted.get('birdSettings', { sfx:true, music:false, haptics:true, difficulty:'normal', theme:'day' });

      const state = {
        mode: 'ready',
        W: 0, H: 0,
        groundH: 0, playableH: 0,
        baseSpeedX: 0, baseGapH: 0,
        speedX: 0, pipeWidth: 0,
        gapH: 0, spawnGap: 0,
        gravity: 0, jumpV: 0,
        bird: { x:0, y:0, vy:0, r:18 },
        pipes: [],
        distSinceSpawn: 0,
        score: 0, best: 0,
        lastTs: 0
      };

      let loopHandle = 0;

      // Best score
      try { state.best = parseInt(localStorage.getItem('birdBest') || '0', 10); } catch {}
      function saveBest(){ try{ localStorage.setItem('birdBest', String(state.best)); }catch{} }

      // Audio (simple, gesture-unlocked)
      const audio = {
        ctx:null, sfxGain:null, musicGain:null, timer:null, step:0,
        init(){
          if(this.ctx) return;
          const AC = window.AudioContext || window.webkitAudioContext;
          if(!AC) return;
          this.ctx = new AC();
          this.sfxGain = this.ctx.createGain();
          this.musicGain = this.ctx.createGain();
          this.sfxGain.gain.value = settings.sfx? 0.35:0.0;
          this.musicGain.gain.value = settings.music? 0.12:0.0;
          this.sfxGain.connect(this.ctx.destination);
          this.musicGain.connect(this.ctx.destination);
        },
        resume(){ if(this.ctx && this.ctx.state==='suspended') this.ctx.resume(); },
        unlock(){ this.init(); this.resume(); },
        sfx(name){
          if(!this.ctx || !settings.sfx) return;
          const now = this.ctx.currentTime;
          const o = this.ctx.createOscillator();
          const g = this.ctx.createGain();
          o.connect(g); g.connect(this.sfxGain);
          g.gain.value = 0;

          if(name==='flap'){
            o.type='triangle';
            o.frequency.setValueAtTime(700, now);
            o.frequency.exponentialRampToValueAtTime(420, now+0.12);
            g.gain.linearRampToValueAtTime(0.4, now+0.02);
            g.gain.exponentialRampToValueAtTime(0.0008, now+0.18);
            o.start(now); o.stop(now+0.22);
          } else if(name==='score'){
            o.type='sine';
            o.frequency.setValueAtTime(900, now);
            o.frequency.exponentialRampToValueAtTime(1300, now+0.09);
            g.gain.linearRampToValueAtTime(0.45, now+0.015);
            g.gain.exponentialRampToValueAtTime(0.0008, now+0.14);
            o.start(now); o.stop(now+0.16);
          } else if(name==='hit'){
            o.type='square';
            o.frequency.setValueAtTime(160, now);
            g.gain.linearRampToValueAtTime(0.35, now+0.02);
            g.gain.exponentialRampToValueAtTime(0.0008, now+0.25);
            o.start(now); o.stop(now+0.3);
          }
        },
        startMusic(){
          if(!this.ctx || this.timer || !settings.music) return;
          this.resume();
          const ctx = this.ctx;
          const bpm = 100, beat = 60/bpm;
          const melody=[523.25,659.25,783.99,659.25,587.33,698.46,880.00,698.46];
          const bass=[130.81,146.83,130.81,98.00];
          this.step=0;
          this.timer = setInterval(()=>{
            const now = ctx.currentTime + 0.02;
            // melody
            const m=ctx.createOscillator(), mg=ctx.createGain();
            m.type='triangle';
            m.frequency.setValueAtTime(melody[this.step%melody.length], now);
            mg.gain.setValueAtTime(0, now);
            mg.gain.linearRampToValueAtTime(0.12, now+0.03);
            mg.gain.exponentialRampToValueAtTime(0.0001, now+beat*0.9);
            m.connect(mg); mg.connect(this.musicGain);
            m.start(now); m.stop(now+beat);
            // bass
            if(this.step%2===0){
              const b=ctx.createOscillator(), bg=ctx.createGain();
              b.type='square';
              b.frequency.setValueAtTime(bass[(this.step>>1)%bass.length], now);
              bg.gain.setValueAtTime(0, now);
              bg.gain.linearRampToValueAtTime(0.08, now+0.02);
              bg.gain.exponentialRampToValueAtTime(0.0001, now+beat*1.8);
              b.connect(bg); bg.connect(this.musicGain);
              b.start(now); b.stop(now+beat*2);
            }
            this.step++;
          }, beat*1000);
        },
        stopMusic(){ if(this.timer){ clearInterval(this.timer); this.timer=null; } },
        apply(){ if(this.sfxGain) this.sfxGain.gain.value = settings.sfx?0.35:0.0; if(this.musicGain) this.musicGain.gain.value = settings.music?0.12:0.0; }
      };

      // Haptics
      const buzz = (ms)=>{ if(settings.haptics && navigator.vibrate){ try{ navigator.vibrate(ms); }catch{} } };

      // Theme
      function applyTheme(){
        if(settings.theme==='night'){
          game.style.setProperty('--bg-top', '#0a1b34');
          game.style.setProperty('--bg-bot', '#0f365f');
          game.style.setProperty('--pipe-body1', '#1ea247');
          game.style.setProperty('--pipe-body2', '#0b8b3a');
          game.style.setProperty('--pipe-stroke', '#06612a');
          game.style.setProperty('--ui-bg', 'rgba(0,0,0,0.45)');
        } else {
          game.style.setProperty('--bg-top', '#85d6ff');
          game.style.setProperty('--bg-bot', '#c9efff');
          game.style.setProperty('--pipe-body1', '#1dbf43');
          game.style.setProperty('--pipe-body2', '#0aa83a');
          game.style.setProperty('--pipe-stroke', '#0a7a2e');
          game.style.setProperty('--ui-bg', 'rgba(0,0,0,0.28)');
        }
      }

      // Dimensions + difficulty
      function setupDimensions(){
        state.W = game.clientWidth || window.innerWidth;
        state.H = game.clientHeight || window.innerHeight;

        state.groundH = clamp(state.H * 0.12, 60, 120);
        state.playableH = state.H - state.groundH;
        cssVar('--ground-h', state.groundH);

        state.bird.r = clamp(state.H * 0.035, 14, 26);
        cssVar('--bird-size', state.bird.r * 2);

        state.pipeWidth = clamp(state.W * 0.14, 50, 140);
        cssVar('--pipe-w', state.pipeWidth);

        state.baseGapH = clamp(state.H * 0.26, 140, 360);
        state.baseSpeedX = state.W / 2.6;

        let gapFactor=1, speedFactor=1, gFactor=1, jFactor=1;
        if (settings.difficulty==='easy'){ gapFactor=1.15; speedFactor=0.9; gFactor=0.95; jFactor=0.98; }
        else if (settings.difficulty==='hard'){ gapFactor=0.85; speedFactor=1.1; gFactor=1.05; jFactor=1.02; }

        state.gapH = clamp(state.baseGapH * gapFactor, 120, 420);
        state.speedX = state.baseSpeedX * speedFactor;
        state.gravity = 2.6 * state.playableH * gFactor;
        state.jumpV = -1.05 * state.playableH * jFactor;

        state.spawnGap = Math.max(state.W * 0.58, 3.2 * state.pipeWidth);

        const period = Math.max(0.2, 100 / state.speedX);
        groundEl.style.setProperty('--ground-period', period + 's');
      }

      function resetToReady(){
        cancelAnimationFrame(loopHandle);
        state.mode = 'ready';
        state.pipes.length = 0;
        pipesLayer.innerHTML = '';
        state.distSinceSpawn = 0;
        state.score = 0; scoreEl.textContent = '0';
        groundEl.classList.remove('scrolling');
        gameover.classList.add('hidden');
        msg.classList.remove('hidden');

        state.bird.x = state.W * 0.28;
        state.bird.y = state.playableH * 0.5;
        state.bird.vy = 0;
        updateBirdDom(0);
      }

      function startGame(){
        if (state.mode === 'playing') return;
        msg.classList.add('hidden');
        gameover.classList.add('hidden');
        groundEl.classList.add('scrolling');

        state.mode = 'playing';
        state.pipes.length = 0;
        pipesLayer.innerHTML = '';
        state.distSinceSpawn = 0;
        state.score = 0; scoreEl.textContent = '0';

        spawnPipe();
        state.lastTs = performance.now();
        loopHandle = requestAnimationFrame(loop);

        audio.unlock(); audio.apply();
        audio.stopMusic(); if (settings.music) audio.startMusic();
      }

      function pauseGame(){ if(state.mode!=='playing') return; state.mode='paused'; groundEl.classList.remove('scrolling'); }
      function resumeGame(){ if(state.mode!=='paused') return; state.mode='playing'; groundEl.classList.add('scrolling'); state.lastTs=performance.now(); loopHandle=requestAnimationFrame(loop); }

      function endGame(){
        if (state.mode!=='playing') return;
        state.mode='gameover';
        groundEl.classList.remove('scrolling');

        if(state.score > state.best){ state.best = state.score; saveBest(); }
        finalScoreEl.textContent = state.score;
        bestScoreEl.textContent = state.best;
        gameover.classList.remove('hidden');

        audio.sfx('hit'); buzz(60);
      }

      function spawnPipe(){
        const minGapY = state.gapH/2 + state.playableH*0.1;
        const maxGapY = state.playableH - state.gapH/2 - state.playableH*0.1;
        const gapY = clamp(rand(minGapY, maxGapY), minGapY, maxGapY);
        const x = state.W + state.pipeWidth;

        const el = document.createElement('div'); el.className='pipe'; el.style.width = state.pipeWidth + 'px';
        const top = document.createElement('div'); top.className='part top';
        const bottom = document.createElement('div'); bottom.className='part bottom';
        el.appendChild(top); el.appendChild(bottom); pipesLayer.appendChild(el);

        const topH = Math.max(0, gapY - state.gapH/2);
        const bottomH = Math.max(0, state.playableH - (gapY + state.gapH/2));
        top.style.height = topH + 'px';
        bottom.style.height = bottomH + 'px';

        const pipe = { x, el, top, bottom, scored:false };
        state.pipes.push(pipe);
        setPipeX(pipe);
      }

      function setPipeX(pipe){ pipe.el.style.left = Math.round(pipe.x) + 'px'; }

      function circleRectCollide(cx, cy, r, rx, ry, rw, rh){
        const closestX = Math.max(rx, Math.min(cx, rx + rw));
        const closestY = Math.max(ry, Math.min(cy, ry + rh));
        const dx = cx - closestX, dy = cy - closestY;
        return (dx*dx + dy*dy) <= r*r;
      }

      function updateBirdDom(rotRad){
        const x = Math.round(state.bird.x - state.bird.r);
        const y = Math.round(state.bird.y - state.bird.r);
        birdEl.style.transform = `translate3d(${x}px, ${y}px, 0) rotate(${rotRad}rad)`;
      }

      function flap(){
        if(state.mode==='ready'){
          startGame();
          state.bird.vy = state.jumpV * 0.9;
          audio.sfx('flap');
          return;
        }
        if(state.mode!=='playing') return;
        state.bird.vy = Math.max(state.bird.vy + state.jumpV * 0.75, state.jumpV);
        audio.sfx('flap');
      }

      function loop(ts){
        const dt = Math.min(0.032, (ts - state.lastTs) / 1000);
        state.lastTs = ts;

        // Bird physics
        state.bird.vy += state.gravity * dt;
        state.bird.y += state.bird.vy * dt;

        // Pipes movement
        const dx = state.speedX * dt;
        state.distSinceSpawn += dx;
        for(const p of state.pipes){ p.x -= dx; setPipeX(p); }

        // Spawn/cleanup
        if(state.distSinceSpawn >= state.spawnGap){ state.distSinceSpawn = 0; spawnPipe(); }
        while(state.pipes.length && state.pipes[0].x + state.pipeWidth < 0){
          const old = state.pipes.shift(); old.el.remove();
        }

        // Score
        for(const p of state.pipes){
          if(!p.scored && p.x + state.pipeWidth < state.bird.x){
            p.scored = true; state.score++; scoreEl.textContent = String(state.score);
            audio.sfx('score'); buzz(10);
          }
        }

        // Collisions
        const EDGE_PAD = 2;
        const r = state.bird.r * 0.85; // forgiving hitbox
        const cx = state.bird.x, cy = state.bird.y;

        let collided = false;
        if (cy - r <= EDGE_PAD) collided = true;
        if (cy + r >= state.playableH - EDGE_PAD) collided = true;

        if(!collided){
          for(const p of state.pipes){
            const rx = p.x, rw = state.pipeWidth;
            const nearX = (cx + r) >= (rx - 2) && (cx - r) <= (rx + rw + 2);
            if(!nearX) continue;
            const topH = parseFloat(p.top.style.height)||0;
            const bottomH = parseFloat(p.bottom.style.height)||0;
            if (topH>0 && circleRectCollide(cx, cy, r, rx, 0, rw, topH)) { collided = true; break; }
            const by = state.playableH - bottomH;
            if (bottomH>0 && circleRectCollide(cx, cy, r, rx, by, rw, bottomH)) { collided = true; break; }
          }
        }

        // Rotate visual
        const rot = clamp(state.bird.vy / (1.6 * state.playableH), -0.9, 1.0);
        updateBirdDom(rot);

        if(collided){ endGame(); return; }
        if(state.mode==='playing') loopHandle = requestAnimationFrame(loop);
      }

      // Input: tapLayer only (so UI clicks never start the game)
      const supportsPointer = 'onpointerdown' in window;
      if (supportsPointer) {
        tapLayer.addEventListener('pointerdown', (e)=>{ e.stopPropagation(); flap(); });
      } else {
        tapLayer.addEventListener('touchstart', (e)=>{ e.preventDefault(); e.stopPropagation(); flap(); }, { passive:false });
        tapLayer.addEventListener('mousedown', (e)=>{ e.stopPropagation(); flap(); });
      }

      // Stop UI events from bubbling to tapLayer
      function shield(el){ ['pointerdown','touchstart','mousedown','click'].forEach(t=>{ el.addEventListener(t, (e)=>e.stopPropagation(), {passive:false}); }); }
      [msg, gameover, settingsPanel, settingsBtn, playBtn, restartBtn, closeSettings, sfxToggle, musicToggle, hapticsToggle, difficultySel, themeSel, resetBestBtn].forEach(shield);

      // Buttons
      playBtn.addEventListener('click', ()=> startGame());
      restartBtn.addEventListener('click', ()=> { resetToReady(); startGame(); });
      settingsBtn.addEventListener('click', ()=> { audio.unlock(); openSettings(); });
      closeSettings.addEventListener('click', ()=> closeSettingsPanel());
      resetBestBtn.addEventListener('click', ()=> { state.best=0; saveBest(); bestScoreEl.textContent='0'; });

      // Keyboard
      window.addEventListener('keydown', (e)=>{
        const k = (e.code || e.key || '').toLowerCase();
        if (k==='space' || k==='arrowup' || k==='keyw') { e.preventDefault(); flap(); }
        else if (k==='enter' && state.mode==='ready') { e.preventDefault(); startGame(); }
        else if (k==='keys') { e.preventDefault(); toggleSettings(); }
        else if (k==='keyp') { e.preventDefault(); (state.mode==='playing')? pauseGame() : (state.mode==='paused'? resumeGame() : null); }
        else if (k==='keyr') { e.preventDefault(); resetToReady(); startGame(); }
        else if (k==='keym') { e.preventDefault(); settings.music=!settings.music; syncSettingsUI(); applySettings(); persistSettings(); }
        else if (k==='keyf') { e.preventDefault(); settings.sfx=!settings.sfx; syncSettingsUI(); audio.apply(); persistSettings(); }
        else if (k==='keyh') { e.preventDefault(); settings.haptics=!settings.haptics; syncSettingsUI(); persistSettings(); }
        else if (k==='keyt') { e.preventDefault(); settings.theme=(settings.theme==='day'?'night':'day'); syncSettingsUI(); applyTheme(); persistSettings(); }
        else if (k==='digit1'||k==='numpad1') { settings.difficulty='easy'; syncSettingsUI(); setupDimensions(); persistSettings(); }
        else if (k==='digit2'||k==='numpad2') { settings.difficulty='normal'; syncSettingsUI(); setupDimensions(); persistSettings(); }
        else if (k==='digit3'||k==='numpad3') { settings.difficulty='hard'; syncSettingsUI(); setupDimensions(); persistSettings(); }
        else if (k==='escape') { if(!settingsPanel.classList.contains('hidden')) closeSettingsPanel(); }
      });

      // Settings helpers
      function syncSettingsUI(){
        sfxToggle.checked = !!settings.sfx;
        musicToggle.checked = !!settings.music;
        hapticsToggle.checked = !!settings.haptics;
        difficultySel.value = settings.difficulty;
        themeSel.value = settings.theme;
      }
      function persistSettings(){ persisted.set('birdSettings', settings); }
      function applySettings(){
        applyTheme(); setupDimensions();
        audio.apply(); if(settings.music) audio.startMusic(); else audio.stopMusic();
      }
      function openSettings(){ if(state.mode==='playing') pauseGame(); syncSettingsUI(); settingsPanel.classList.remove('hidden'); }
      function closeSettingsPanel(){ settingsPanel.classList.add('hidden'); if(state.mode==='paused') resumeGame(); }
      function toggleSettings(){ settingsPanel.classList.contains('hidden') ? openSettings() : closeSettingsPanel(); }

      // Settings UI events
      sfxToggle.addEventListener('change', ()=>{ settings.sfx=sfxToggle.checked; persistSettings(); audio.init(); audio.apply(); });
      musicToggle.addEventListener('change', ()=>{ settings.music=musicToggle.checked; persistSettings(); audio.init(); audio.apply(); if(settings.music) audio.startMusic(); else audio.stopMusic(); });
      hapticsToggle.addEventListener('change', ()=>{ settings.haptics=hapticsToggle.checked; persistSettings(); });
      difficultySel.addEventListener('change', ()=>{ settings.difficulty=difficultySel.value; persistSettings(); setupDimensions(); });
      themeSel.addEventListener('change', ()=>{ settings.theme=themeSel.value; persistSettings(); applyTheme(); });

      // Auto pause on hide
      document.addEventListener('visibilitychange', ()=>{ if(document.hidden && state.mode==='playing') pauseGame(); });

      // Resize handling
      let resizeTimer=0;
      window.addEventListener('resize', ()=>{
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(()=>{ setupDimensions(); resetToReady(); }, 120);
      });

      // Init
      applyTheme();
      setupDimensions();
      audio.init();
      resetToReady();
    })();
  </script>
</body>
</html>
